FROM jboss/keycloak:24.0.3

RUN mkdir /opt/keycloak
RUN mkdir /tmp/keycloak/

# Set the working directory
WORKDIR /opt/keycloak

# Copy the Keycloak source code to the container
COPY . /opt/keycloak

# Build Keycloak
RUN mvn clean install -DskipTests

ENV KEYCLOAK_VERSION 999.0.0-SNAPSHOT
ARG KEYCLOAK_DIST=quarkus/dist/target/keycloak-$KEYCLOAK_VERSION.tar.gz

RUN dnf install -y tar gzip

RUN mv $KEYCLOAK_DIST /tmp/keycloak/

# The next step makes it uniform for local development and upstream built.
# If it is a local tar archive then it is unpacked, if from remote is just downloaded.
RUN (cd /tmp/keycloak && \
    tar -xvf /tmp/keycloak/keycloak-*.tar.gz && \
    rm /tmp/keycloak/keycloak-*.tar.gz) || true

RUN mv /tmp/keycloak/keycloak-* /opt/keycloak && mkdir -p /opt/keycloak/data
RUN chmod -R g+rwX /opt/keycloak


# Expose the Keycloak port
EXPOSE 8080

# Start Keycloak
CMD ["/opt/keycloak/bin/kc.sh", "start-dev"]